# Sealed Secrets - Media Stack

**Purpose:** Encrypted secrets for disaster recovery
**Controller:** bitnami-labs/sealed-secrets v0.27.1
**Location:** `sealed-secrets.yaml` (safe to commit to Git)

---

## What Are Sealed Secrets?

**Sealed Secrets** encrypt Kubernetes Secrets using your cluster's public key. Only the Sealed Secrets controller running in your cluster has the private key to decrypt them.

**Benefits:**
- ✅ Secrets encrypted in Git (safe to commit)
- ✅ Disaster recovery (rebuild cluster from Git)
- ✅ Industry best practice for GitOps
- ✅ Controller automatically decrypts into regular Secrets

---

## Current Sealed Secret

**File:** `sealed-secrets.yaml`
**Contains:** 6 API keys for media stack services

| Secret Key | Purpose | Source |
|------------|---------|--------|
| `prowlarr-api-key` | Prowlarr API authentication | Auto-generated by Prowlarr |
| `radarr-api-key` | Radarr API authentication | Auto-generated by Radarr |
| `sonarr-api-key` | Sonarr API authentication | Auto-generated by Sonarr |
| `lidarr-api-key` | Lidarr API authentication | Auto-generated by Lidarr |
| `sabnzbd-api-key` | SABnzbd API authentication | Auto-generated by SABnzbd |
| `qbittorrent-password` | qBittorrent web UI password | Set via web UI |

**Status:** Deployed to cluster, decrypted as Secret `media-stack-secrets` in namespace `media`

---

## How to Retrieve Secret Values

If you need to view the decrypted values (e.g., for manual configuration):

```bash
# View all secret keys
kubectl get secret media-stack-secrets -n media -o json | jq -r '.data | keys[]'

# Retrieve specific API key
kubectl get secret media-stack-secrets -n media -o jsonpath='{.data.prowlarr-api-key}' | base64 -d
kubectl get secret media-stack-secrets -n media -o jsonpath='{.data.radarr-api-key}' | base64 -d
kubectl get secret media-stack-secrets -n media -o jsonpath='{.data.sonarr-api-key}' | base64 -d
kubectl get secret media-stack-secrets -n media -o jsonpath='{.data.lidarr-api-key}' | base64 -d
kubectl get secret media-stack-secrets -n media -o jsonpath='{.data.sabnzbd-api-key}' | base64 -d
kubectl get secret media-stack-secrets -n media -o jsonpath='{.data.qbittorrent-password}' | base64 -d
```

---

## How to Update Sealed Secrets

If API keys change or you need to add new secrets:

### Step 1: Extract Current API Keys

```bash
cat > /tmp/extract-secrets.sh <<'EOF'
#!/bin/bash
echo "PROWLARR_API_KEY=$(kubectl exec -n media deployment/prowlarr -- cat /config/config.xml 2>/dev/null | grep "<ApiKey>" | sed 's/.*<ApiKey>\(.*\)<\/ApiKey>.*/\1/' | tr -d ' \n\r')"
echo "RADARR_API_KEY=$(kubectl exec -n media deployment/radarr -- cat /config/config.xml 2>/dev/null | grep "<ApiKey>" | sed 's/.*<ApiKey>\(.*\)<\/ApiKey>.*/\1/' | tr -d ' \n\r')"
echo "SONARR_API_KEY=$(kubectl exec -n media deployment/sonarr -- cat /config/config.xml 2>/dev/null | grep "<ApiKey>" | sed 's/.*<ApiKey>\(.*\)<\/ApiKey>.*/\1/' | tr -d ' \n\r')"
echo "LIDARR_API_KEY=$(kubectl exec -n media deployment/lidarr -- cat /config/config.xml 2>/dev/null | grep "<ApiKey>" | sed 's/.*<ApiKey>\(.*\)<\/ApiKey>.*/\1/' | tr -d ' \n\r')"
echo "SABNZBD_API_KEY=$(kubectl exec -n media deployment/sabnzbd -- cat /config/sabnzbd.ini 2>/dev/null | grep '^api_key' | cut -d= -f2 | tr -d ' \n\r')"
echo "QBITTORRENT_PASSWORD=YOUR_PASSWORD_HERE"
EOF

chmod +x /tmp/extract-secrets.sh
bash /tmp/extract-secrets.sh > /tmp/media-secrets.env
source /tmp/media-secrets.env
```

### Step 2: Create and Seal New Secret

```bash
# Create regular secret manifest
kubectl create secret generic media-stack-secrets \
  --from-literal=prowlarr-api-key="${PROWLARR_API_KEY}" \
  --from-literal=radarr-api-key="${RADARR_API_KEY}" \
  --from-literal=sonarr-api-key="${SONARR_API_KEY}" \
  --from-literal=lidarr-api-key="${LIDARR_API_KEY}" \
  --from-literal=sabnzbd-api-key="${SABNZBD_API_KEY}" \
  --from-literal=qbittorrent-password="${QBITTORRENT_PASSWORD}" \
  --namespace=media \
  --dry-run=client -o yaml > /tmp/media-secrets.yaml

# Seal it (encrypt)
kubeseal --format=yaml < /tmp/media-secrets.yaml > apps/media/base/sealed-secrets.yaml

# Apply to cluster
kubectl apply -f apps/media/base/sealed-secrets.yaml

# Clean up
rm /tmp/media-secrets.yaml /tmp/media-secrets.env /tmp/extract-secrets.sh
```

### Step 3: Commit to Git

```bash
git add apps/media/base/sealed-secrets.yaml
git commit -m "Update sealed secrets for media stack"
git push
```

---

## Disaster Recovery with Sealed Secrets

### Scenario: Rebuild Cluster from Scratch

1. **Rebuild Talos cluster** (follow TALOS_INSTALLATION_PLAYBOOK.md)

2. **Install Sealed Secrets controller**
   ```bash
   kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.27.1/controller.yaml
   kubectl wait --for=condition=available --timeout=120s deployment/sealed-secrets-controller -n kube-system
   ```

3. **Clone Git repository**
   ```bash
   git clone YOUR_REPO_URL
   cd k8_cluster
   ```

4. **Deploy media stack** (includes sealed secret)
   ```bash
   kubectl apply -k apps/media/base/
   ```

5. **Verify secret was decrypted**
   ```bash
   kubectl get secret media-stack-secrets -n media
   # Should show: DATA 6
   ```

6. **Services will start with API keys already configured!**

**Important:** API keys are stored in service config files on NFS. Sealed secrets provide a **backup** for disaster recovery. Services will regenerate keys on first start if configs are missing.

---

## Sealed Secrets Controller Details

**Namespace:** kube-system
**Pod:** sealed-secrets-controller
**Service:** sealed-secrets-controller (metrics on port 8080)

### View Controller Logs

```bash
kubectl logs -n kube-system deployment/sealed-secrets-controller
```

### Fetch Cluster Public Key

```bash
kubeseal --fetch-cert > /tmp/sealed-secrets-cert.pem
cat /tmp/sealed-secrets-cert.pem
```

### Backup Encryption Keys (Critical!)

The controller's private key is stored in a Secret:

```bash
kubectl get secret -n kube-system sealed-secrets-key -o yaml > sealed-secrets-private-key-backup.yaml
# Store this somewhere VERY safe (encrypted backup)
# If you lose this, you can't decrypt your sealed secrets
```

**⚠️ WARNING:** Keep this backup in a secure location! If you lose the private key, sealed secrets cannot be decrypted.

---

## Troubleshooting

### Sealed Secret Not Decrypting

**Symptom:** SealedSecret exists but regular Secret not created

```bash
# Check controller logs
kubectl logs -n kube-system deployment/sealed-secrets-controller

# Common issues:
# 1. Wrong namespace (sealed secret must specify correct namespace)
# 2. Controller not running (check: kubectl get pods -n kube-system)
# 3. Sealed with wrong certificate (re-seal with fresh cert)
```

### Re-seal Secret with Fresh Certificate

```bash
# Fetch current cluster certificate
kubeseal --fetch-cert > /tmp/fresh-cert.pem

# Re-seal using the fresh certificate
kubeseal --cert /tmp/fresh-cert.pem --format=yaml < /tmp/media-secrets.yaml > apps/media/base/sealed-secrets.yaml
```

### Verify Decryption

```bash
# Check if regular Secret exists
kubectl get secret media-stack-secrets -n media

# View decrypted value
kubectl get secret media-stack-secrets -n media -o jsonpath='{.data.prowlarr-api-key}' | base64 -d
```

---

## Security Notes

### Is This Safe for Git?

**Yes!** Sealed secrets are encrypted with your cluster's public key. Even if someone has access to your Git repository, they **cannot decrypt** the secrets without the private key stored in your cluster.

### What If Git Gets Leaked?

**Low Risk:** Encrypted secrets are useless without the cluster's private key. However:
- Keep the private key backup VERY secure (see backup section above)
- Don't commit the private key to Git
- Use a private Git repository (your home server is fine)

### What About Plex Claim Token?

**Not in Sealed Secret:** Plex claim tokens expire in 4 minutes and cannot be reused. Get a fresh token when deploying:

```bash
# Get token from: https://www.plex.tv/claim/
# Apply manually:
kubectl set env deployment/plex PLEX_CLAIM=claim-XXXXX -n media

# Or claim via web UI: http://10.69.1.154:32400/web
```

---

## References

- **Sealed Secrets GitHub:** https://github.com/bitnami-labs/sealed-secrets
- **Controller Version:** v0.27.1
- **kubeseal CLI Version:** v0.32.2 (installed via Homebrew)
- **Installation Date:** October 5, 2025
- **Applied to:** media namespace

---

**Last Updated:** October 5, 2025
**Status:** ✅ Operational, sealed secret deployed and decrypted
